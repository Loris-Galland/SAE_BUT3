stages:
  - build
  - test
  - security
  - deploy

variables:
  DOCKER_DRIVER: overlay2

.docker_login: &docker_login
  - echo "$DOCKER_HUB_TOKEN" | docker login --username $DOCKER_HUB_USER --password-stdin

build:frontend:
  stage: build
  image: docker:25-cli
  tags:
    - dind
  before_script:
    - *docker_login
  script:
    - docker build -t $DOCKER_HUB_USER/sae-s5-but3-iot-g1-frontend:$CI_COMMIT_SHORT_SHA ./frontend
    - docker build -t $DOCKER_HUB_USER/sae-s5-but3-iot-g1-frontend:latest ./frontend
    - docker push $DOCKER_HUB_USER/sae-s5-but3-iot-g1-frontend:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_HUB_USER/sae-s5-but3-iot-g1-frontend:latest
  only:
    refs:
      - main
      - develop

build:backend:
  stage: build
  image: docker:25-cli
  tags:
    - dind
  before_script:
    - *docker_login
  script:
    - docker build -t $DOCKER_HUB_USER/sae-s5-but3-iot-g1-backend:$CI_COMMIT_SHORT_SHA ./backend
    - docker build -t $DOCKER_HUB_USER/sae-s5-but3-iot-g1-backend:latest ./backend
    - docker push $DOCKER_HUB_USER/sae-s5-but3-iot-g1-backend:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_HUB_USER/sae-s5-but3-iot-g1-backend:latest
  only:
    refs:
      - main
      - develop

build:nodered:
  stage: build
  image: docker:25-cli
  tags:
    - dind
  before_script:
    - *docker_login
  script:
    - docker build -t $DOCKER_HUB_USER/sae-s5-but3-iot-g1-nodered:$CI_COMMIT_SHORT_SHA ./nodered
    - docker build -t $DOCKER_HUB_USER/sae-s5-but3-iot-g1-nodered:latest ./nodered
    - docker push $DOCKER_HUB_USER/sae-s5-but3-iot-g1-nodered:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_HUB_USER/sae-s5-but3-iot-g1-nodered:latest
  only:
    refs:
      - main
      - develop

test:frontend:unit:
  stage: test
  image: node:18-alpine
  tags:
    - dind
  before_script:
    - cd frontend
    - npm ci
  script:
    - npm run test || echo "Tests non configurés"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
    paths:
      - frontend/coverage/
    expire_in: 1 week
  only:
    refs:
      - main
      - develop

test:backend:unit:
  stage: test
  image: node:18-alpine
  tags:
    - dind
  before_script:
    - cd backend
    - npm ci
  script:
    - npm run test || echo "Tests non configurés"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage/cobertura-coverage.xml
    paths:
      - backend/coverage/
    expire_in: 1 week
  only:
    refs:
      - main
      - develop

security:npm-audit:
  stage: security
  image: node:18-alpine
  tags:
    - dind
  script:
    - cd backend && npm audit --audit-level=high || true
    - cd ../frontend && npm audit --audit-level=high || true
  only:
    refs:
      - main
      - develop

security:trivy:
  stage: security
  image: docker:25-cli
  tags:
    - dind
  before_script:
    - apk add --no-cache curl bash
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - *docker_login
    - docker pull $DOCKER_HUB_USER/sae-s5-but3-iot-g1-frontend:latest
    - docker pull $DOCKER_HUB_USER/sae-s5-but3-iot-g1-backend:latest
    - docker pull $DOCKER_HUB_USER/sae-s5-but3-iot-g1-nodered:latest
  script:
    - trivy image --severity HIGH,CRITICAL --exit-code 0 --no-progress $DOCKER_HUB_USER/sae-s5-but3-iot-g1-frontend:latest
    - trivy image --severity HIGH,CRITICAL --exit-code 0 --no-progress $DOCKER_HUB_USER/sae-s5-but3-iot-g1-backend:latest
    - trivy image --severity HIGH,CRITICAL --exit-code 0 --no-progress $DOCKER_HUB_USER/sae-s5-but3-iot-g1-nodered:latest
  only:
    refs:
      - main
      - develop

deploy:
  stage: deploy
  needs:
    - build:frontend
    - build:backend
    - build:nodered
    - test:frontend:unit
    - test:backend:unit
    - security:trivy
  image: docker:25-cli
  tags:
    - dind
  before_script:
    - *docker_login
  script:
    - export DOCKER_HUB_USER=$DOCKER_HUB_USER
    - docker-compose -f docker-compose.staging.yml pull
    - docker-compose -f docker-compose.staging.yml down --remove-orphans || true
    - docker rm -f mosquitto mysql nodered backend frontend 2>/dev/null || true
    - docker-compose -f docker-compose.staging.yml up -d
  environment:
    name: app
  only:
    refs:
      - main
      - develop